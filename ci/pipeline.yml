---
#@ load("@ytt:data", "data")

#! ************************************
#! Secrets we need to run this pipeline
#! ************************************
secrets:
#! github_access_token is used to create PRs and fetch github releases.
- &github_access_token ((github_read_write_token))

- &aws-access
#! AWS access keys for the 686843836666 account
  access_key_id: &aws_access_key ((bbr_aws_access_key.username))
  secret_access_key: &aws_secret_key ((bbr_aws_access_key.password))
  aws_role_arn: &aws_role_arn ((bbr_aws_access_key.role_arn))
- &AWS_ACCESS
  AWS_ACCESS_KEY: *aws_access_key
  AWS_ASSUMED_ROLE_ARN: *aws_role_arn
  AWS_SECRET_KEY: *aws_secret_key
- &AWS_ACCESS_2
  ACCESS_KEY: *aws_access_key
  SECRET_KEY: *aws_secret_key
  ROLE_ARN: *aws_role_arn

#! gcp_service_accounts_bucket_owner was needed on 2023-09-25 to access gcs buckets required in this pipeline (e.g. semver resource). It was generated by using personal creds to log into the mapbu-cryogenics GCP project
- &gcp_service_accounts_bucket_owner ((broadcom_labs_gcp_credentials_json))

#! as of 23/04/2024 gchat webhook is used to send us ci status messages. It was created in gchat space settings after logging in with personal creds
- &gchat_webhook ((gchat-webhook-dap-bosh-ecosystem-dev))

#! They are static values stored in credhub.
- &test-bosh-director-ip 10.244.0.5
- &test-bosh-director-ip-priv-key ((test_bosh_director_ssh_key.private_key))
- &test-bosh-director-ip-pub-key ((test_bosh_director_ssh_key.public_key))

- &shepherd_account_key ((bosh-ecosystem-shepherd-service-account))
- &shepherd_lvn_account_key ((bosh-ecosystem-shepherd-service-account-lvn))
#! shepherd_account_key was needed on 2023-09-28 to claim shepherd environments. It was created using `shepherd create service-account` after logging in with WS1.

- &docker_username ((docker.username))
- &docker_password ((docker.password))

#! Access token for our service account user in Github Enterprise
- &ghe_svc_account_personal_access_token ((svc-bosh-ecosystem-ghe-personal-access-token))

#! Artifactory token
- &artifactory_token ((broadcom_artifactory_api_key))

#! **************
#! End of secrets
#! **************

number_of_claim_env_retries: &number_of_claim_env_retries 1
number_of_system_test_retries: &number_of_system_test_retries 3

#! These are just recurring mappings to vars loaded via load_var steps.
ts-bosh-env: &ts-bosh-env
  BOSH_ENVIRONMENT: "((.:pooled-env.BOSH_ENVIRONMENT))"
  BOSH_CLIENT: "((.:pooled-env.BOSH_CLIENT))"
  BOSH_CLIENT_SECRET: "((.:pooled-env.BOSH_CLIENT_SECRET))"
  BOSH_CA_CERT: "((.:pooled-env.BOSH_CA_CERT))"
  BOSH_GW_HOST: "((.:pooled-env.INSTANCE_JUMPBOX_EXTERNAL_IP)):22"
  BOSH_GW_USER: "((.:pooled-env.INSTANCE_JUMPBOX_USER))"
  BOSH_GW_PRIVATE_KEY: "((.:pooled-env.INSTANCE_JUMPBOX_PRIVATE))"

ts-2-bosh-env: &ts-2-bosh-env
  BOSH_ENVIRONMENT: ((.:additional-pooled-env.BOSH_ENVIRONMENT))
  BOSH_CLIENT: ((.:additional-pooled-env.BOSH_CLIENT))
  BOSH_CLIENT_SECRET: ((.:additional-pooled-env.BOSH_CLIENT_SECRET))
  BOSH_CA_CERT: "((.:additional-pooled-env.BOSH_CA_CERT))"
  BOSH_GW_HOST: "((.:additional-pooled-env.INSTANCE_JUMPBOX_EXTERNAL_IP)):22"
  BOSH_GW_USER: "((.:additional-pooled-env.INSTANCE_JUMPBOX_USER))"
  BOSH_GW_PRIVATE_KEY: "((.:additional-pooled-env.INSTANCE_JUMPBOX_PRIVATE))"

test-bosh-director-deployment: &test-bosh-director-deployment test-bosh-director

resource_types:

#! The shepherd-v1 resource definition can be found here: https://github.gwd.broadcom.net/TNZ/shepherd/tree/main/resource
- name: shepherd-v1
  type: registry-image
  source:
    repository: tas-gen-ai-docker-dev-local.usw1.packages.broadcom.com/ci/shepherd-resource
    tag: v1
    username: svc.bosh-ecosystem
    password: *artifactory_token
  tags: [broadcom]

- name: shepherd-v2
  tags: [broadcom]
  source:
    tag: v1 #! yep, really.
    repository: tas-bosh-docker-dev-local.usw1.packages.broadcom.com/cryogenics/shepherd2-concourse-resource
    username: svc.bosh-ecosystem
    password: *artifactory_token
  type: registry-image

- name: bosh-deployment-resource
  type: registry-image
  source:
    repository: cloudfoundry/bosh-deployment-resource
    username: *docker_username
    password: *docker_password

- name: gcs
  type: registry-image
  source:
    repository: frodenas/gcs-resource
    username: *docker_username
    password: *docker_password

- name: google-chat-notify-resource
  type: registry-image
  source:
    repository: springio/google-chat-notify-resource
    username: *docker_username
    password: *docker_password
    tag: 0.0.1-SNAPSHOT

resources:
- name: bosh-ecosystem-registry-image
  type: registry-image
  source:
    repository: bosh/bosh-ecosystem-concourse
    username: *docker_username
    password: *docker_password

- name: bosh-security-scanner-registry-image
  type: registry-image
  source:
    repository: bosh/security-scanner
    username: *docker_username
    password: *docker_password

- name: cf-deployment-concourse-tasks-registry-image
  type: registry-image
  source:
    repository: cloudfoundry/cf-deployment-concourse-tasks
    username: *docker_username
    password: *docker_password

- name: golang-registry-image
  type: registry-image
  source:
    repository: golang
    username: *docker_username
    password: *docker_password

- name: golang-release
  type: git
  source:
    uri: https://github.com/bosh-packages/golang-release.git
    tag_filter: v*
- name: golang-release-image
  type: registry-image
  source:
    repository: ghcr.io/cloudfoundry/bosh/golang-release

- name: bbr-director-test-releases
  type: git
  source:
    uri: https://github.com/cloudfoundry/bosh-backup-and-restore-test-releases.git
    branch: master
    paths:
    - test-bosh-backup-and-restore-release

- name: bbr-deployment-test-releases
  type: git
  source:
    uri: https://github.com/cloudfoundry/bosh-backup-and-restore-test-releases.git
    branch: master
    paths:
    - redis-test-release
    - lock-ordering-release
    - many-bbr-jobs-release

- name: bosh-backup-and-restore
  type: git
  source:
    uri: https://github.com/cloudfoundry/bosh-backup-and-restore.git
    username: bosh-admin-bot
    password: *github_access_token
    branch: master
    disable_git_lfs: true
    ignore_paths:
    - ci

- name: bosh-backup-and-restore-ci
  type: git
  source:
    uri: https://github.com/cloudfoundry/bosh-backup-and-restore.git
    username: bosh-admin-bot
    password: *github_access_token
    branch: master
    disable_git_lfs: true
    paths:
    - ci

- name: homebrew-tap
  type: git
  source:
    uri: https://github.com/cloudfoundry/homebrew-tap.git
    branch: master
    username: bosh-admin-bot
    password: *github_access_token

- name: bosh-shared-ci
  type: git
  source:
    uri: https://github.com/cloudfoundry/bosh-shared-ci.git

- name: bbr-dev-release
  type: gcs
  source:
    bucket: bbr-pipeline
    json_key: *gcp_service_accounts_bucket_owner
    versioned_file: bbr-cli/bbr-dev-release.tar

- name: bbr-release
  type: github-release
  source:
    repository: bosh-backup-and-restore
    user: cloudfoundry
    access_token: *github_access_token
    release: true

- name: version
  type: semver
  source:
    bucket: bbr-pipeline
    key: bosh-backup-and-restore/version
    json_key: *gcp_service_accounts_bucket_owner
    driver: gcs

#! When using shepherd v2 bosh lite, we can't use the google stemcell
#! - name: jammy-stemcell
#!   type: bosh-io-stemcell
#!   source:
#!     name: bosh-google-kvm-ubuntu-jammy-go_agent

- name: jammy-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-warden-boshlite-ubuntu-jammy-go_agent

- name: bosh-deployment
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/bosh-deployment.git

- name: test-bosh-director-deployment
  type: bosh-deployment-resource
  source:
    deployment: *test-bosh-director-deployment
    skip_check: true

- name: additional-test-bosh-director-deployment
  type: bosh-deployment-resource
  source:
    deployment: ci
    skip_check: true

- name: s3-config-validator-dev-release
  type: gcs
  source:
    bucket: bbr-pipeline
    json_key: *gcp_service_accounts_bucket_owner
    versioned_file: validator-test-artifacts/bbr-s3-config-validator

- name: release-notes
  type: gcs
  source:
    bucket: bbr-pipeline
    json_key: *gcp_service_accounts_bucket_owner
    versioned_file: bosh-backup-and-restore/release-notes.md

- name: cryogenics-concourse-tasks
  type: git
  tags: [broadcom]
  source:
    uri: https://github.gwd.broadcom.net/TNZ/cryogenics-concourse-tasks.git
    branch: main
    username: svc.bosh-ecosystem@broadcom.net
    password: *ghe_svc_account_personal_access_token

- name: gchat-notification
  type: google-chat-notify-resource
  source:
    url: *gchat_webhook

- name: cf-deployment-concourse-tasks
  type: git
  source:
    branch: main
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git


- name: cf-deployment
  type: git
  source:
    uri: https://github.com/cloudfoundry/cf-deployment.git
    branch: main

- name: environment
  type: shepherd-v2
  tags: [broadcom]
  source:
    url: https://v2-shepherd.lvn.broadcom.net
    service-account-key: *shepherd_lvn_account_key
    lease:
      namespace: bosh-ecosystem
      template:
        name: cfd-bosh-lite
        namespace: official
        revision: "3.0"
        arguments:
          gcp_region: us-west1
          vm_type: n2d-standard-8
          root_disk_gb: 32
          disk_pool_gb: 200
          cfd_version: ""
          cfd_additional_opsfiles_b64: "LS0tCi0gdHlwZTogcmVwbGFjZQogIHBhdGg6IC9hZGRvbnMvbmFtZT1ib3NoLWRucy1hbGlhc2VzL2pvYnMvbmFtZT1ib3NoLWRucy1hbGlhc2VzL3Byb3BlcnRpZXMvYWxpYXNlcy8tCiAgdmFsdWU6CiAgICBkb21haW46IF8uKChzeXN0ZW1fZG9tYWluKSkKICAgIHRhcmdldHM6CiAgICAgIC0gZGVwbG95bWVudDogY2YKICAgICAgICBkb21haW46IGJvc2gKICAgICAgICBpbnN0YW5jZV9ncm91cDogcm91dGVyCiAgICAgICAgbmV0d29yazogZGVmYXVsdAogICAgICAgIHF1ZXJ5OiAiKiI="
          bosh_additional_opsfiles_b64: ""

- name: additional-environment
  type: shepherd-v2
  tags: [broadcom]
  source:
    url: https://v2-shepherd.lvn.broadcom.net
    service-account-key: *shepherd_lvn_account_key
    lease:
      namespace: bosh-ecosystem
      template:
        name: cfd-bosh-lite
        namespace: official
        revision: "3.0"
        arguments:
          gcp_region: us-west1
          vm_type: n2d-standard-8
          root_disk_gb: 32
          disk_pool_gb: 200
          cfd_version: ""
          cfd_additional_opsfiles_b64: "LS0tCi0gdHlwZTogcmVwbGFjZQogIHBhdGg6IC9hZGRvbnMvbmFtZT1ib3NoLWRucy1hbGlhc2VzL2pvYnMvbmFtZT1ib3NoLWRucy1hbGlhc2VzL3Byb3BlcnRpZXMvYWxpYXNlcy8tCiAgdmFsdWU6CiAgICBkb21haW46IF8uKChzeXN0ZW1fZG9tYWluKSkKICAgIHRhcmdldHM6CiAgICAgIC0gZGVwbG95bWVudDogY2YKICAgICAgICBkb21haW46IGJvc2gKICAgICAgICBpbnN0YW5jZV9ncm91cDogcm91dGVyCiAgICAgICAgbmV0d29yazogZGVmYXVsdAogICAgICAgIHF1ZXJ5OiAiKiI="
          bosh_additional_opsfiles_b64: ""

- name: drats-env
  type: shepherd-v2
  source:
    url: https://v2-shepherd.lvn.broadcom.net
    service-account-key: *shepherd_lvn_account_key
    lease:
      namespace: bosh-ecosystem
      template:
        name: cfd-bosh-lite
        namespace: official
        revision: "3.0"
        arguments:
          gcp_region: us-west1
          vm_type: n2d-standard-8
          root_disk_gb: 32
          disk_pool_gb: 200
          cfd_version: ""
          cfd_additional_opsfiles_b64: "LS0tCi0gdHlwZTogcmVwbGFjZQogIHBhdGg6IC9hZGRvbnMvbmFtZT1ib3NoLWRucy1hbGlhc2VzL2pvYnMvbmFtZT1ib3NoLWRucy1hbGlhc2VzL3Byb3BlcnRpZXMvYWxpYXNlcy8tCiAgdmFsdWU6CiAgICBkb21haW46IF8uKChzeXN0ZW1fZG9tYWluKSkKICAgIHRhcmdldHM6CiAgICAgIC0gZGVwbG95bWVudDogY2YKICAgICAgICBkb21haW46IGJvc2gKICAgICAgICBpbnN0YW5jZV9ncm91cDogcm91dGVyCiAgICAgICAgbmV0d29yazogZGVmYXVsdAogICAgICAgIHF1ZXJ5OiAiKiI="
          bosh_additional_opsfiles_b64: ""

- name: b-drats-env
  type: shepherd-v2
  source:
    url: https://v2-shepherd.lvn.broadcom.net
    service-account-key: *shepherd_lvn_account_key
    lease:
      namespace: bosh-ecosystem
      pool:
        name: epc-tas-10_2_0-lite
        namespace: official

- name: disaster-recovery-acceptance-tests
  type: git
  source:
    uri: https://github.com/cloudfoundry/disaster-recovery-acceptance-tests
    branch: main

- name: b-drats
  type: git
  source:
    uri: https://github.com/cloudfoundry/bosh-disaster-recovery-acceptance-tests
    branch: master

- name: every-monday
  type: time
  source:
    initial_version: true
    start: 9:00 AM
    stop: 5:00 PM
    days: [Monday,Friday]
    location: Europe/London

jobs:
- name: system-test-director
  serial: true
  serial_groups: [ system-test-director ]
  plan:
  - in_parallel:
    - get: environment
      passed: [ claim-env ]
      trigger: true
      tags: [broadcom]
    - get: bosh-backup-and-restore-ci
    - get: bosh-backup-and-restore
      passed: [ claim-env ]
    - get: bosh-deployment
    - get: bbr-director-test-releases
    - get: jammy-stemcell
    - get: cryogenics-concourse-tasks
      tags: [broadcom]
      passed: [ claim-env ]
    - get: bosh-ecosystem-registry-image
  - task: alias-env
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bosh-envify/task.yml
  - load_var: pooled-env
    file: bosh-env/metadata.yml
    format: yml
  - task: generate-bosh-deployment-source-file
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bosh-deployment-resource-source-file-adapter/task.yml
    params:
      <<: *ts-bosh-env
  - put: deploy-fake-director
    resource: test-bosh-director-deployment
    params:
      manifest: bosh-backup-and-restore/fixtures/fake-director.yml
      stemcells: [ jammy-stemcell/*.tgz ]
      source_file: source-file/source-file.yml
      vars:
        deployment-name: test-bosh-director
        jumpbox-public-key: *test-bosh-director-ip-pub-key
        test_release_path: /tmp/build/put/bbr-director-test-releases/test-bosh-backup-and-restore-release
        internal_ip: *test-bosh-director-ip
    tags: [broadcom]
  - task: system-test-director
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bbr-system-director/task.yml
    privileged: true
    tags: [broadcom]
    params:
      USE_SHUTTLE: false
      DIRECTOR_HOST: *test-bosh-director-ip
      DIRECTOR_SSH_KEY: *test-bosh-director-ip-priv-key
      DIRECTOR_SSH_USERNAME: jumpbox
      BOSH_DEPLOYMENT: *test-bosh-director-deployment
      <<: *ts-bosh-env

  - put: delete-system-director
    resource: test-bosh-director-deployment
    params:
      delete:
        enabled: true
      source_file: source-file/source-file.yml
    tags: [broadcom]

- name: system-test-deployment
  serial: true
  plan:
  - in_parallel:
    - get: bbr-deployment-test-releases
      trigger: true
    - get: environment
      passed: [ claim-env ]
      trigger: true
      tags: [broadcom]
    - get: additional-environment
      passed: [ claim-env ]
      tags: [broadcom]
    - get: bosh-backup-and-restore-ci
    - get: bosh-backup-and-restore
      passed: [ claim-env ]
    - get: bbr-director-test-releases
    - get: jammy-stemcell
    - get: bosh-ecosystem-registry-image
    - get: cryogenics-concourse-tasks
      tags: [broadcom]
      passed: [ claim-env ]
  - task: alias-env
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bosh-envify/task.yml
  - load_var: pooled-env
    file: bosh-env/metadata.yml
    format: yml
  - task: alias-additional-env
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bosh-envify/task.yml
    input_mapping:
      environment: additional-environment
    output_mapping:
      bosh-env: additional-bosh-env
  - load_var: additional-pooled-env
    file: additional-bosh-env/metadata.yml
    format: yml
  - task: generate-bosh-deployment-source-file
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bosh-deployment-resource-source-file-adapter/task.yml
    params:
      <<: *ts-2-bosh-env
  - put: deploy-fake-director
    resource: additional-test-bosh-director-deployment
    params:
      manifest: bosh-backup-and-restore/fixtures/fake-director.yml
      stemcells: [ jammy-stemcell/*.tgz ]
      source_file: source-file/source-file.yml
      vars:
        deployment-name: ci
        jumpbox-public-key: *test-bosh-director-ip-pub-key
        test_release_path: /tmp/build/put/bbr-director-test-releases/test-bosh-backup-and-restore-release
        internal_ip: *test-bosh-director-ip
    tags: [broadcom]
  - in_parallel:
    - task: upload-redis-test-release-to-bosh
      image: bosh-ecosystem-registry-image
      file: bosh-backup-and-restore-ci/ci/tasks/bbr-upload-system-test-releases/task.yml
      params:
        RELEASE_NAME: redis-test-release
        <<: *ts-2-bosh-env
      tags: [broadcom]
    - task: upload-many-bbr-jobs-release-to-bosh-uaa
      image: bosh-ecosystem-registry-image
      file: bosh-backup-and-restore-ci/ci/tasks/bbr-upload-system-test-releases/task.yml
      params:
        RELEASE_NAME: many-bbr-jobs-release
        <<: *ts-2-bosh-env
      tags: [broadcom]
    - task: upload-many-bbr-jobs-release-to-bosh
      image: bosh-ecosystem-registry-image
      file: bosh-backup-and-restore-ci/ci/tasks/bbr-upload-system-test-releases/task.yml
      params:
        RELEASE_NAME: many-bbr-jobs-release
        <<: *ts-bosh-env
      tags: [broadcom]
    - task: upload-redis-test-release-to-bosh
      image: bosh-ecosystem-registry-image
      file: bosh-backup-and-restore-ci/ci/tasks/bbr-upload-system-test-releases/task.yml
      params:
        RELEASE_NAME: redis-test-release
        <<: *ts-bosh-env
      tags: [broadcom]
    - task: upload-redis-test-release-to-bosh-uaa
      image: bosh-ecosystem-registry-image
      file: bosh-backup-and-restore-ci/ci/tasks/bbr-upload-system-test-releases/task.yml
      params:
        RELEASE_NAME: redis-test-release
        <<: *ts-2-bosh-env
      tags: [broadcom]
    - task: upload-lock-ordering-release-to-bosh-uaa
      image: bosh-ecosystem-registry-image
      file: bosh-backup-and-restore-ci/ci/tasks/bbr-upload-system-test-releases/task.yml
      params:
        RELEASE_NAME: lock-ordering-release
        <<: *ts-2-bosh-env
      tags: [broadcom]

    - task: allow-connections-to-bosh-director-on-port-25555
      image: bosh-ecosystem-registry-image
      config:
        platform: linux
        inputs:
        - name: additional-environment
        params:
          <<: *ts-2-bosh-env
        run:
          path: /bin/bash
          args:
          - -c
          - |
            #!/bin/bash
            # . <(smith -l additional-environment/metadata bosh)
            # ENV_NAME=$(cat additional-environment/metadata | jq .name -r)

            echo -e "${BOSH_GW_PRIVATE_KEY}" > "${PWD}/ssh.key"
            chmod 0600 "${PWD}/ssh.key"
            export BOSH_GW_PRIVATE_KEY="${PWD}/ssh.key"
            export BOSH_ALL_PROXY="ssh+socks5://${BOSH_GW_USER}@${BOSH_GW_HOST}?private-key=${BOSH_GW_PRIVATE_KEY}"

            bosh cc > cc.yml
            bosh ucc -n <( bosh int cc.yml -o <( echo -e "- type: replace\n  path: /vm_types/name=minimal/cloud_properties?/tags?\n  value: [${ENV_NAME}-bosh-open]") )
      tags: [broadcom]


  - task: system-deployment-with-uaa
    image: bosh-ecosystem-registry-image
    attempts: *number_of_system_test_retries
    file: bosh-backup-and-restore-ci/ci/tasks/bbr-system-deployment/task.yml
    params:
      <<: *ts-2-bosh-env
    tags: [broadcom]

- name: test-build-s3-config-validator
  serial_groups:
  - only_1_job_should_bump_the_BUILD_VERSION_at_a_time_to_avoid_race_condition
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore-ci
    - get: bosh-backup-and-restore
      trigger: true
    - get: bosh-ecosystem-registry-image
  - task: unit-test
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bbr-s3-config-validator-unit-test/task.yml
    params:
      <<: *AWS_ACCESS
  - task: e2e-test
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bbr-s3-config-validator-e2e-test/task.yml
    params:
      <<: *AWS_ACCESS
  - task: build
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bbr-s3-config-validator-build/task.yml
  - put: s3-config-validator-dev-release
    params:
      file: bbr-s3-config-validator-build/bbr-s3-config-validator

- name: validate-aws-s3-config
  serial: true
  plan:
  - in_parallel:
    - get: s3-config-validator-dev-release
      passed: [ test-build-s3-config-validator ]
      trigger: true
    - get: bosh-backup-and-restore-ci
    - get: bosh-backup-and-restore
      passed: [ test-build-s3-config-validator ]
    - get: bosh-ecosystem-registry-image
  - task: run-validator
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bbr-s3-config-validator-validate-aws-s3-config/task.yml
    params:
      <<: *AWS_ACCESS_2

- name: release-fan-in
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore
      passed: [ system-test-deployment, system-test-director, validate-aws-s3-config ]
      trigger: true

- name: build-dev
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore-ci
    - get: bosh-backup-and-restore
      trigger: true
      passed: [release-fan-in]
    - get: bosh-ecosystem-registry-image
  - task: build-bbr
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bbr-build/task.yml
  - task: build-s3-config-validator
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bbr-s3-config-validator-build/task.yml
  - put: bbr-dev-release
    params:
      file: bbr-build/bbr-*.tar

- name: run-drats
  serial: true
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore-ci
    - get: bosh-backup-and-restore
      passed: [claim-drats-env]
    - get: cf-deployment
    - get: cf-deployment-concourse-tasks
    - get: disaster-recovery-acceptance-tests
    - get: bosh-ecosystem-registry-image
    - get: cf-deployment-concourse-tasks-registry-image
    - get: bbr-dev-release
      trigger: true
      passed: [claim-drats-env]
    - get: drats-env
      trigger: true
      passed: [claim-drats-env]
      tags: [broadcom]
  - task: copy-shepherd-ops-files-into-cfd
    image: cf-deployment-concourse-tasks-registry-image
    file: cf-deployment-concourse-tasks/collect-ops-files/task.yml
    tags: [broadcom]
    input_mapping:
      base-ops-files: cf-deployment
      new-ops-files: bosh-backup-and-restore-ci
    output_mapping:
      collected-ops-files: opsfiles
    params:
      BASE_OPS_FILE_DIR: operations/
      NEW_OPS_FILES: ci/ops-files/add_dns_alias.yml
  - task: deploy-backup-restore-components
    image: cf-deployment-concourse-tasks-registry-image
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    tags: [broadcom]
    input_mapping:
      toolsmiths-env: drats-env
      ops-files: opsfiles
    params:
      OPS_FILES: >
        operations/bosh-lite.yml
        operations/scale-to-one-az.yml
        operations/use-compiled-releases.yml
        operations/experimental/fast-deploy-with-downtime-and-danger.yml
        operations/backup-and-restore/enable-backup-restore.yml
        operations/enable-nfs-volume-service.yml
        operations/experimental/disable-interpolate-service-bindings.yml
        operations/experimental/enable-traffic-to-internal-networks.yml
        operations/enable-smb-volume-service.yml
        operations/backup-and-restore/skip-backup-restore-droplets-and-packages.yml
        operations/add_dns_alias.yml
  - task: bosh-run-errand-nfsbrokerpush
    image: cf-deployment-concourse-tasks-registry-image
    attempts: 5
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    tags: [broadcom]
    input_mapping:
      toolsmiths-env: drats-env
    params:
      ERRAND_NAME: nfsbrokerpush
  - task: bosh-run-errand-smbbrokerpush
    image: cf-deployment-concourse-tasks-registry-image
    attempts: 5
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    tags: [broadcom]
    input_mapping:
      toolsmiths-env: drats-env
    params:
      ERRAND_NAME: smbbrokerpush
  - load_var: pooled-env
    file: drats-env/metadata
    format: json
  - task: update-integration-config
    image: cf-deployment-concourse-tasks-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/setup-drats-integration-config/task.yml
    tags: [broadcom]
    input_mapping:
      integration-configs: disaster-recovery-acceptance-tests
      cf-deployment-env: drats-env
    params:
      SYSTEM_DOMAIN: ((.:pooled-env.name)).cf-app.com
      JUMPBOX_PRIVATE_KEY: ((.:pooled-env.bosh.jumpbox_private_key))
      CREDHUB_CLIENT: ((.:pooled-env.bosh.credhub_client))
      CREDHUB_SECRET: ((.:pooled-env.bosh.credhub_secret))
      CREDHUB_CA_CERT: ((.:pooled-env.bosh.credhub_ca_cert))
      CREDHUB_SERVER: ((.:pooled-env.bosh.credhub_server))
      CREDHUB_PROXY: ((.:pooled-env.bosh.bosh_all_proxy))
      BOSH_ENVIRONMENT: ((.:pooled-env.bosh.bosh_environment))
      BOSH_CA_CERT: ((.:pooled-env.bosh.bosh_ca_cert))
      BOSH_ALL_PROXY: ((.:pooled-env.bosh.bosh_all_proxy))
      BOSH_CLIENT: ((.:pooled-env.bosh.bosh_client))
      BOSH_CLIENT_SECRET: ((.:pooled-env.bosh.bosh_client_secret))
  - task: acceptance-tests
    image: cf-deployment-concourse-tasks-registry-image
    file: disaster-recovery-acceptance-tests/ci/tasks/drats-with-integration-config/task.yml
    privileged: true
    tags: [broadcom]
    input_mapping:
      drats-integration-config: updated-integration-configs
      bbr-binary-release: bbr-dev-release
      environment: drats-env
    params:
      CONFIG_FILE_PATH: ci/integration_config.json
      CF_DIAL_TIMEOUT: 300
  - put: drats-env
    tags: [broadcom]
    params:
      action: release
      resource: drats-env

- name: run-b-drats
  serial: true
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore-ci
    - get: bosh-backup-and-restore
      passed: [claim-b-drats-env]
    - get: b-drats
    - get: bbr-dev-release
      trigger: true
      params: {unpack: true}
      passed: [claim-b-drats-env]
    - get: jammy-stemcell
    - get: bosh-ecosystem-registry-image
    - get: b-drats-env
      trigger: true
      passed: [claim-b-drats-env]
      tags: [broadcom]
  - task: create-b-drats-config
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/setup-b-drats-integration-config/task.yml
    tags: [nimbus]
    input_mapping:
      environment: b-drats-env
      stemcell: jammy-stemcell
    params:
      INCLUDE_DEPLOYMENT_TESTCASE: true
      INCLUDE_TRUNCATE_DB_BLOBSTORE_TESTCASE: false
      INCLUDE_CREDHUB_TESTCASE: false
      TIMEOUT_IN_MINUTES: 2_880 #! 48h
    output_mapping:
      config: b-drats-config
  - load_var: env-metadata
    file: b-drats-env/metadata
    format: json
  - task: run-b-drats
    image: bosh-ecosystem-registry-image
    file: b-drats/ci/tasks/run-b-drats/task.yml
    privileged: true
    tags: [nimbus]
    input_mapping:
      bosh-disaster-recovery-acceptance-tests: b-drats
      bbr-binary-release: bbr-dev-release
      b-drats-integration-config: b-drats-config
      environment: b-drats-env
    params:
      JUMPBOX_IP: ((.:env-metadata.ops_manager_public_ip))
      JUMPBOX_PRIVATE_KEY: ((.:env-metadata.ops_manager_private_key))
      JUMPBOX_USER: ubuntu
      BBR_BINARY: bbr-binary-release/releases/bbr
      SSH_ALIVE_INTERVAL: 60 #! in seconds
      GINKGO_TIMEOUT: 48h0m0s #! 48h to be consistent with TIMEOUT_IN_MINUTES in the b-drats test config from the previous task.
  - put: b-drats-env
    tags: [broadcom]
    params:
      action: release
      resource: b-drats-env

- name: release-new-patch
  serial_groups:
    - version
  plan:
    - put: version
      params:
        bump: patch

- name: release-new-minor
  serial_groups:
    - version
  plan:
    - put: version
      params:
        bump: minor

- name: release-new-major
  serial_groups:
    - version
  plan:
    - put: version
      params:
        bump: major

- name: automatically-release-new-patch
  serial_groups: [version]
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore-ci
    - get: bosh-backup-and-restore
      trigger: true
      passed:
      - run-drats
      - run-b-drats
    - get: current-version
      resource: version
    - get: patched-version
      resource: version
      params:
        bump: patch
    - get: bosh-shared-ci
    - get: bosh-security-scanner-registry-image
  - try:
      task: check-for-patched-cves
      file: bosh-shared-ci/tasks/release/check-for-patched-cves.yml
      image: bosh-security-scanner-registry-image
      input_mapping:
        input_repo: bosh-backup-and-restore
        version: current-version
      params:
        SEVERITY: CRITICAL,HIGH
      on_success:
        do:
          - put: release-notes
            params:
              file: release-notes/release-notes.md
          - put: version
            params:
              file: patched-version/version
  - task: ensure-cve-checker-succeeded
    file: bosh-shared-ci/tasks/release/ensure-task-succeeded.yml
    image: bosh-security-scanner-registry-image
    input_mapping:
      task-output-folder: patched_cves

- name: publish-release
  disable_manual_trigger: true
  serial_groups: [version]
  plan:
  - in_parallel:
    - get: bosh-backup-and-restore-ci
    - get: bosh-backup-and-restore
      passed:
      - run-drats
      - run-b-drats
    - get: version
      trigger: true
    - get: bosh-ecosystem-registry-image
    - get: release-notes
  - load_var: version-number
    file: version/version
  - task: build-bbr
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bbr-build/task.yml
  - task: build-s3-config-validator
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bbr-s3-config-validator-build/task.yml
  - task: package-release
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/package-release/task.yml
  - put: bbr-release
    params:
      name: version/version
      tag: version/version
      tag_prefix: v
      body: release-notes/release-notes.md
      commitish: bosh-backup-and-restore/.git/ref
      generate_release_notes: true
      globs:
      - packaged-release/*
  - put: release-notes
    params:
      file: release_metadata/empty-file
  - load_var: github-release-url
    file: bbr-release/url
  - put: gchat-notification
    inputs: []
    params:
      text: |
        *BBR CLI*: version `((.:version-number))` has been published to github!
        Next steps: Review the release notes <((.:github-release-url))|here>.

- name: update-homebrew-formula
  serial: true
  plan:
  - in_parallel:
    - get: homebrew-tap
    - get: bbr-release
      passed:
      - publish-release
      trigger: true
    - get: bosh-backup-and-restore-ci
    - get: bosh-backup-and-restore
      passed:
      - publish-release
    - get: bosh-ecosystem-registry-image
  - task: update-homebrew-formula
    image: bosh-ecosystem-registry-image
    file: bosh-backup-and-restore-ci/ci/tasks/bbr-update-homebrew-formula/task.yml
  - put: homebrew-tap
    params:
      repository: updated-homebrew-tap
      rebase: true

- name: claim-env
  plan:
  - in_parallel:
      steps:
      - get: bosh-backup-and-restore-ci
      - get: bosh-backup-and-restore
        trigger: true
      - get: cryogenics-concourse-tasks
        tags: [broadcom]
      - put: environment
        tags: [broadcom]
        attempts: *number_of_claim_env_retries
        timeout: 6h
        params:
          action: create
          duration: 24h
          resource: environment
          timeout: 6h
      - put: additional-environment
        tags: [broadcom]
        attempts: *number_of_claim_env_retries
        timeout: 6h
        params:
          action: create
          duration: 24h
          resource: additional-environment
          timeout: 6h

- name: claim-drats-env
  plan:
    - in_parallel:
        steps:
          - get: bosh-backup-and-restore
            trigger: true
            passed: [build-dev]
          - get: bbr-dev-release
            tags: [broadcom]
            passed: [build-dev]
          - put: drats-env
            tags: [broadcom]
            attempts: *number_of_claim_env_retries
            timeout: 6h
            params:
              action: create
              duration: 24h
              timeout: 6h
              resource: drats-env

- name: claim-b-drats-env
  plan:
    - in_parallel:
        steps:
          - get: bosh-backup-and-restore
            trigger: true
            passed: [build-dev]
          - get: bbr-dev-release
            tags: [broadcom]
            passed: [build-dev]
          - put: b-drats-env
            tags: [broadcom]
            attempts: *number_of_claim_env_retries
            timeout: 6h
            params:
              action: create
              duration: 24h
              timeout: 6h
              resource: b-drats-env

- name: unclaim-env
  plan:
  - in_parallel:
      steps:
      - get: bosh-backup-and-restore-ci
      - get: bosh-backup-and-restore
        trigger: true
        passed:
        - system-test-deployment
        - system-test-director
      - get: environment
        passed:
        - system-test-deployment
        - system-test-director
        tags: [broadcom]
      - get: additional-environment
        passed:
        - system-test-deployment
        tags: [broadcom]
  - put: environment
    params:
      action: release
      resource: environment
    tags: [broadcom]
  - put: additional-environment
    params:
      action: release
      resource: additional-environment
    tags: [broadcom]

- name: bump-deps-bbr-cli
  plan:
  - in_parallel:
    - get: golang-release-image
    - get: every-monday
      trigger: true
    - get: bosh-backup-and-restore
    - get: bosh-backup-and-restore-ci
    - get: golang-release
    - get: golang-registry-image
  - task: bump-deps
    file: golang-release/ci/tasks/shared/bump-deps.yml
    image: golang-release-image
    tags: [broadcom]
    input_mapping:
      input_repo: bosh-backup-and-restore
    output_mapping:
      output_repo: bosh-backup-and-restore
    params:
      GOPROXY: ((repository_mirrors.goproxy))
      GOSUMDB: ((repository_mirrors.gosumdb))
      GOOS_LIST: linux,windows
  - task: lint
    file: bosh-backup-and-restore-ci/ci/tasks/run-make/task.yml
    image: golang-registry-image
    params:
      MAKE_TARGET: lint
  - task: test
    file: bosh-backup-and-restore-ci/ci/tasks/run-make/task.yml
    image: golang-registry-image
    params:
      MAKE_TARGET: test-unit
  - put: bosh-backup-and-restore
    params:
      repository: bosh-backup-and-restore
      rebase: true

- name: bump-deps-s3-config-validator
  plan:
  - in_parallel:
    - get: golang-release-image
    - get: every-monday
      trigger: true
    - get: bosh-backup-and-restore
    - get: bosh-backup-and-restore-ci
    - get: golang-release
    - get: golang-registry-image
  - task: bump-deps
    file: golang-release/ci/tasks/shared/bump-deps.yml
    image: golang-release-image
    tags: [broadcom]
    input_mapping:
      input_repo: bosh-backup-and-restore
    output_mapping:
      output_repo: bosh-backup-and-restore
    params:
      SOURCE_PATH: s3-config-validator/src/
      GOPROXY: ((repository_mirrors.goproxy))
      GOSUMDB: ((repository_mirrors.gosumdb))
  - task: test-unit-s3-config-validator
    file: bosh-backup-and-restore-ci/ci/tasks/test-unit-s3-config-validator/task.yml
    image: golang-registry-image
  - put: bosh-backup-and-restore
    params:
      repository: bosh-backup-and-restore
      rebase: true

